DECLARE array_expr STRING;

SET array_expr = (
  SELECT
    'ARRAY_CONCAT([' ||
    STRING_AGG(
      FORMAT(
        'ARRAY(SELECT AS STRUCT ''%s'' AS Column_Name,
                           CAST(%s AS STRING) AS Column_Value,
                           ''%s'' AS Data_Type
               FROM UNNEST([1])
               WHERE %s IS NOT NULL)',
        column_name,         -- used in CAST(%s AS STRING)
        column_name,         -- used in WHERE %s IS NOT NULL
        data_type,           -- data type literal
        column_name          -- same column for WHERE
      ),
      ','
    )
    || '])'
  FROM dev-edap.region-us.INFORMATION_SCHEMA.COLUMNS
  WHERE table_catalog = src_project
    AND table_schema  = src_dataset
    AND table_name    = src_table
);
